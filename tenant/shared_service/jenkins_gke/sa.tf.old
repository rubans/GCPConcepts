data "google_project" "default" {
  project_id = var.project
}

# module "google_service_account" {
#   source        = "../../../modules//iam/service_account/"
#   display_name  = local.service_account_id
#   description   = local.service_account_id
#   project       = data.google_project.default
#   roles         = ["roles/compute.admin"]
#   account_id    = local.service_account_id
# }

data "google_service_account" "jenkins-sa" {
  account_id = local.service_account_id
}

resource "kubernetes_namespace" "jenkins-namespace" {
  metadata {
    name = var.workload_identity_namespace
  }

}

resource "kubernetes_service_account" "jenkins-ksa" {
  metadata {
    name        = var.workload_identity_user
    namespace   = var.workload_identity_namespace
    annotations = { "iam.gke.io/gcp-service-account" : data.google_service_account.jenkins-sa.email }
  }

}

resource "google_service_account_iam_binding" "admin-account-iam" {
  service_account_id = data.google_service_account.jenkins-sa.name
  role               = "roles/iam.workloadIdentityUser"

  members = [
    "serviceAccount:${var.project}.svc.id.goog[${kubernetes_namespace.jenkins-namespace.metadata[0].name}/${kubernetes_service_account.jenkins-ksa.metadata[0].name}]",
  ]
}
